- name: Install fish
  hosts: coreos:dnf:desktop
  gather_facts: true

  pre_tasks:
    - name: Gather per-host secret files
      ansible.builtin.include_vars:
        file: "{{ item }}"
      loop:
        - "../inventories/prod/secret_vars/{{ inventory_hostname }}/base.yaml"
      when: lookup('ansible.builtin.fileglob', item) | length > 0
  
  vars:
    ansible_shell_executable: /bin/sh
  tasks:
    
    - name: Fish | install fish shell
      block:

        - name: Fish | check if fish is installed
          ansible.builtin.shell: |
            set -euo pipefail
            IFS=$'\n\t'

            echo "running as $(ps -p $$ -o comm=)"
            
            which fish
          register: check_if_fish_is_installed
          changed_when: false
          failed_when: check_if_fish_is_installed.rc >= 2
          args:
            executable: /usr/bin/bash
    
        - name: Fish | install via dnf
          become: true
          ansible.builtin.dnf:
            name:
              - fish
            state: present
          when:
            - ansible_facts["pkg_mgr"] in ['dnf', 'dnf5']
            - check_if_fish_is_installed.rc == 1

    - name: Fish | Configure fish shell for user {{ main_user }}
      block:

        - name: Fish | ensures /home/{{ main_user }}/.bashrc.d/ directory exists
          ansible.builtin.file:
            path: /home/{{ main_user }}/.bashrc.d/
            state: directory
            owner: "{{ main_user }}"
            group: "{{ main_user }}"
            mode: '755'

        - name: Fish | ensures /home/{{ main_user }}/.config/fish/conf.d/ directory exists
          ansible.builtin.file:
            path: /home/{{ main_user }}/.config/fish/conf.d/
            state: directory
            owner: "{{ main_user }}"
            group: "{{ main_user }}"
            mode: '755'

        - name: Fish | set theme (ayu Dark)
          ansible.builtin.copy:
            content: |
              if status is-interactive
                fish_config theme choose "ayu Dark"
              end
            dest: /home/{{ main_user }}/.config/fish/conf.d/theme.fish
            owner: "{{ main_user }}"
            group: "{{ main_user }}"
            mode: '644'

        - name: Fish | rsync functions
          ansible.posix.synchronize:
            src: "../files/functions/"
            dest: "/home/{{ main_user }}/.config/fish/functions/"
            delete: yes

- name: Install ntfy-server-boot service and timer
  hosts: coreos:dnf:desktop
  become: true
  vars_files:
    - "../inventories/prod/secret_vars/all.yaml"
  
  pre_tasks:
    - name: Gather per-host secret files
      ansible.builtin.include_vars:
        file: "{{ item }}"
      loop:
        - "../inventories/prod/secret_vars/{{ inventory_hostname }}/base.yaml"
        - "../inventories/prod/secret_vars/{{ inventory_hostname }}/ntfy.yaml"
      when: lookup('ansible.builtin.fileglob', item) | length > 0

  tasks:

    - name: Install ntfy-server-boot | Copy ntfy-server-boot.service file
      ansible.builtin.template:
        src: ../files/ntfy-server-boot/ntfy-server-boot.service
        dest: /etc/systemd/system/ntfy-server-boot.service
        mode: '640'
      register: ntfy_service

    - name: Install ntfy-server-boot | Copy ntfy-server-boot.timer file
      ansible.builtin.template:
        src: ../files/ntfy-server-boot/ntfy-server-boot.timer
        dest: /etc/systemd/system/ntfy-server-boot.timer
        mode: '640'
      register: ntfy_timer

    - name: Install ntfy-server-boot | reload daemon for system
      ansible.builtin.systemd_service:
        daemon_reload: true
        scope: system
      when: >
        ntfy_service.changed | default(false) or
        ntfy_timer.changed | default(false)

    - name: Install ntfy-server-boot | Enable and start ntfy-server-boot.timer
      systemd:
        name: ntfy-server-boot.timer
        enabled: yes
        state: started
        
    - name: Install ntfy-server-boot | ensures /home/{{ main_user }}/.local/bin directory exists
      ansible.builtin.file:
        path: /home/{{ main_user }}/.local/bin
        state: directory
        owner: "{{ main_user }}"
        group: "{{ main_user }}"
        mode: '755'
        
    - name: Install ntfy-server-boot | Copy ntfy.fish file
      ansible.builtin.copy:
        src: ../files/ntfy-server-boot/ntfy.fish
        dest: /home/{{ main_user }}/.local/bin/ntfy.fish
        owner: "{{ main_user }}"
        group: "{{ main_user }}"
        mode: '700'
      register: ntfy_fish_file

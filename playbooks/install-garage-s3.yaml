- name: Install Garage s3
  hosts: coreos:dnf:desktop
  gather_facts: true
  vars_files:
    - "../inventories/prod/host_vars/{{ inventory_hostname }}.yaml"
    - "../inventories/prod/secret_vars/{{ inventory_hostname }}.yaml"
    - "../inventories/prod/secret_vars/all.yaml"
  vars:
    main_user: core
  
  tasks:
    - name: Install Garage s3 | Setup variables (detect container)
      ansible.builtin.set_fact:
        quadlet_is_container: "{{ (ansible_facts['virtualization_tech_guest'] | default([]) | length) > 0 }}"

    - name: Install Garage s3 | Setup variables (compute once, reuse everywhere)
      ansible.builtin.set_fact:
        quadlet_dir: "{{ '/etc/containers/systemd' if quadlet_is_container else '/home/' ~ main_user ~ '/.config/containers/systemd' }}"
        quadlet_owner: "{{ 'root' if quadlet_is_container else main_user }}"
        quadlet_group: "{{ 'root' if quadlet_is_container else main_user }}"
        quadlet_become: "{{ quadlet_is_container }}"
        systemd_scope: "{{ 'system' if quadlet_is_container else 'user' }}"

    - name: Install Garage s3 | ensures garage main directory exists
      ansible.builtin.file:
        path: "{{ garage_toml_path }}"
        state: directory
        owner: "{{ quadlet_owner }}"
        group: "{{ quadlet_group }}"
        mode: '0750'
      become: true
      
    - name: Install Garage s3 | ensures garage meta directory exists
      ansible.builtin.file:
        path: "{{ garage_meta_path }}"
        state: directory
        owner: "{{ quadlet_owner }}"
        group: "{{ quadlet_group }}"
        mode: '0750'
      become: true
    
    - name: Install Garage s3 | ensures garage data directory exists
      ansible.builtin.file:
        path: "{{ garage_data_path }}"
        state: directory
        owner: "{{ quadlet_owner }}"
        group: "{{ quadlet_group }}"
        mode: '0750'
      become: true
    
    - name: Install Garage s3 | Check a filesystem type for data directory
      ansible.builtin.command:
        cmd: "stat -f -c %T {{ garage_data_path }}"
      register: garage_fs_type
      changed_when: false
      become: true
    
    - name: Install Garage s3 | Disable copy-on-write for garage data directory if BTRFS
      ansible.builtin.shell: |
        if [ "{{ garage_fs_type.stdout }}" == "btrfs" ]; then
          if [ -z "$(ls -A "{{ garage_data_path }}")" ]; then
            chattr +C "{{ garage_data_path }}"
            echo "Directory {{ garage_data_path }} COW is now disabled"
          else
            echo "Directory {{ garage_data_path }} is not empty, skipping disabling COW"
          fi
        else
          echo "Directory {{ garage_data_path }} is on {{ garage_fs_type.stdout }}, not on BTRFS, skipping disabling COW"
        fi
      register: chattr_result
      changed_when: "'skipping' not in chattr_result.stdout"
      become: true
    
    - name: Install Garage s3 | Debug chattr result
      ansible.builtin.debug:
        msg:
          - "STDOUT: {{ chattr_result.stdout }}"
          - "STDERR: {{ chattr_result.stderr }}"

    - name: Install Garage s3 | copy garage.toml settings
      ansible.builtin.template:
        src: "../files/garage/garage.toml"
        dest: "{{ garage_toml_path }}/garage.toml"
        comment_start_string: "# BEGIN_OF_COMMENT"
        comment_end_string: "# END_OF_COMMENT"
        owner: "{{ quadlet_owner }}"
        group: "{{ quadlet_group }}"
        mode: "0600"
      become: true
      register: garage_toml_output

    - name: Install Garage s3 | Install systemd Podman quadlet unit
      ansible.builtin.template:
        src: "../files/garage/garage.container"
        dest: "{{ quadlet_dir }}/garage.container"
        comment_start_string: "# BEGIN_OF_COMMENT"
        comment_end_string: "# END_OF_COMMENT"
        owner: "{{ quadlet_owner }}"
        group: "{{ quadlet_group }}"
        mode: "0600"
      become: "{{ quadlet_become }}"
      register: systemd_podman_quadlet_output

    - name: Install Garage s3 | Restart garage service when unit or config changed
      ansible.builtin.systemd:
        daemon_reload: true
        name: garage.service
        state: restarted
        enabled: true
        scope: "{{ systemd_scope }}"
      become: "{{ quadlet_become }}"
      when: >
        systemd_podman_quadlet_output.changed or
        garage_toml_output.changed

- name: Setup Restic Backup
  hosts: marek246.tailnet-ba52.ts.net:wyse01.tailnet-ba52.ts.net
  gather_facts: true
  vars_files:
    - "../inventories/prod/secret_vars/all.yaml"
  
  pre_tasks:
    - name: Gather per-host secret files
      ansible.builtin.include_vars:
        file: "{{ item }}"
      loop:
        - "../inventories/prod/secret_vars/{{ inventory_hostname }}/base.yaml"
        - "../inventories/prod/secret_vars/{{ inventory_hostname }}/restic.yaml"
      when: lookup('ansible.builtin.fileglob', item) | length > 0
  
  tasks:
    - name: Setup Restic Backup | Setup variables (detect container)
      ansible.builtin.set_fact:
        run_as_root: "{{ ansible_facts['virtualization_tech_guest'] | default([]) | intersect(['lxc', 'container']) | length > 0 }}"

    - name: Setup Restic Backup | Setup variables (compute once, reuse everywhere)
      ansible.builtin.set_fact:
        service_dir: "{{ '/etc/systemd/system' if run_as_root else '/home/' ~ main_user ~ '/.config/systemd/user' }}"
        quadlet_dir: "{{ '/etc/containers/systemd' if run_as_root else '/home/' ~ main_user ~ '/.config/containers/systemd' }}"
        file_owner: "{{ 'root' if run_as_root else main_user }}"
        file_group: "{{ 'root' if run_as_root else main_user }}"
        calculated_become: "{{ run_as_root }}"
        systemd_scope: "{{ 'system' if run_as_root else 'user' }}"
        
    - name: Setup Restic Backup | ensures data directory exists
      ansible.builtin.file:
        path: "{{ restic_env_vars_file_dir }}"
        state: directory
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: "0700"
      become: "{{ calculated_become }}"
        
    - name: Setup Restic Backup | Create restic env file
      ansible.builtin.copy:
        content: "{{ restic_env_vars_file }}"
        dest: "{{ restic_env_vars_file_dir }}/restic.env"
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: "0600"
      become: "{{ calculated_become }}"
    
    - name: Setup Restic Backup | Systemd Podman Quadlet
      ansible.builtin.template:
        src: "../files/restic-backup/server-backup-to-s3.container"
        dest: "{{ quadlet_dir }}/server-backup-to-s3.container"
        comment_start_string: "# BEGIN_OF_COMMENT"
        comment_end_string: "# END_OF_COMMENT"
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: "0640"
      become: "{{ calculated_become }}"
      register: systemd_podman_quadlet_output
      notify: Reload systemd
      
    - name: Setup Restic Backup | Systemd Service
      ansible.builtin.template:
        src: "../files/restic-backup/server-backup-to-s3.timer"
        dest: "{{ service_dir }}/server-backup-to-s3.timer"
        comment_start_string: "# BEGIN_OF_COMMENT"
        comment_end_string: "# END_OF_COMMENT"
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: "0640"
      become: "{{ calculated_become }}"
      register: systemd_service_output
      notify: Reload systemd
    
    - name: Enable timer
      ansible.builtin.systemd:
        daemon_reload: true
        name: server-backup-to-s3.timer
        enabled: true
        state: started
        scope: "{{ systemd_scope }}"
      become: "{{ calculated_become }}"
      
    - name: Setup Restic Backup | Prune Systemd Podman Quadlet
      ansible.builtin.template:
        src: "../files/restic-backup/server-backup-restic-prune-snapshots.container"
        dest: "{{ quadlet_dir }}/server-backup-restic-prune-snapshots.container"
        comment_start_string: "# BEGIN_OF_COMMENT"
        comment_end_string: "# END_OF_COMMENT"
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: "0640"
      become: "{{ calculated_become }}"
      register: systemd_podman_quadlet_output
      notify: Reload systemd
    
    - name: Setup Restic Backup | Prune Systemd Service
      ansible.builtin.template:
        src: "../files/restic-backup/server-backup-restic-prune-snapshots.timer"
        dest: "{{ service_dir }}/server-backup-restic-prune-snapshots.timer"
        comment_start_string: "# BEGIN_OF_COMMENT"
        comment_end_string: "# END_OF_COMMENT"
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: "0640"
      become: "{{ calculated_become }}"
      register: systemd_service_output
      notify: Reload systemd
    
    - name: Enable Prune timer
      ansible.builtin.systemd:
        daemon_reload: true
        name: server-backup-restic-prune-snapshots.timer
        enabled: true
        state: started
        scope: "{{ systemd_scope }}"
      become: "{{ calculated_become }}"
      
  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
        scope: "{{ systemd_scope }}"
      become: "{{ calculated_become }}"
